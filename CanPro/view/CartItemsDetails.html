<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<link href="css/CartItemsStyle.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/css/toastr.css" rel="stylesheet"/>
  		<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/js/toastr.js"></script> 
		<script type="text/javascript">
			window.onload = function displayCartDetails() {
				$.ajax({ 
					type: "GET",
					contentType: 'application/json',
					url: "http://localhost:3000/cart_items",
					success: function(data){							
						var parentDiv=document.createElement('div');						
						for(var i=0;i<data.length;i++)
						{
							var childDivTag=document.createElement('div');
							childDivTag.setAttribute('class',"col-md-3 col-sm-4 col-xs-6");
							var childPTag=document.createElement('p');
							var fontTag=document.createElement('font');												
							var childText=document.createTextNode(data[i].product_name+"    "+data[i].price);
							var imgTag = document.createElement('img');
							imgTag.setAttribute('src',data[i].image_url);
							childDivTag.appendChild(childText);
							childDivTag.appendChild(imgTag);
							var button = document.createElement('button');
							button.setAttribute('onClick',"deleteItemFromTable("+data[i].id+")");
							var textNode=document.createTextNode('Remove Item from Cart');
							button.appendChild(textNode);
							childDivTag.appendChild(button);
							parentDiv.appendChild(childDivTag);
						}
						var orderButton = document.createElement('button');
						var orderTextNode = document.createTextNode('Confirm Your Order');
						orderButton.appendChild(orderTextNode);	
						var JsonData=JSON.stringify(data);				
						orderButton.setAttribute('onClick',"confirmOrder("+JsonData+")");
						parentDiv.appendChild(orderButton);
						document.body.appendChild(parentDiv); 
					},
					error: function(data)
					{
						console.log(data);
					}		
				});				
			}
		</script>
		<script type="text/javascript">
			function deleteItemFromTable(id)
			{		
					$.ajax({ 						
				    type: "DELETE",
					contentType: 'application/json',
					url:"http://localhost:3000/cart_items/"+id,					
					success: function(data){
						location.reload();					
					}
					})
			}			
		</script>
		 <script type="text/javascript">
			function confirmOrder(data)
			{
				console.log(data);
				var sum=0;
				for(var i=0;i<data.length;i++)
				{  
					var price=data[i].price.split(".")
					sum+=parseInt(price[1]);
				}
				var num = Math.floor(Math.random() * 10 + 1);
				var JSONObject={
					"user_id":5,
					"total":sum,
					"order_number":num
				}
				$.ajax({ 						
				    type: "POST",
					contentType: 'application/json',
					url:"http://localhost:3000/orders",
					data:JSON.stringify(JSONObject),
					success: function(data1){
					console.log(data1);	
					bulkInsertItems(data1.id,data);		
					}
				})
			}
			function bulkInsertItems(id,data)
			{    
				console.log(id+data)
				var JSONObject = new Array();
              for(var i=0;i<data.length;i++)
              {
               JSONObject[i]={"item_total":data[i].price,
           						"order_id":id,
           						"product_id":data[i].product_id
           					}
              }
              console.log(JSONObject);
              $.ajax({ 						
				    type: "POST",
					contentType: 'application/json',
					url:"http://localhost:3000/order_items/create_bulk",
					data:JSON.stringify(JSONObject),
					success: function(data){
					redirectTime = "10";
					redirectURL = "http://localhost:4000/dashboard";
					toastr.info('Processing...', { fadeAway:100 });
					toastr.success('You have placed your order successfully!!!');					
					setTimeout("location.href = redirectURL;",redirectTime);				
					removeCartItems();
					
					}
				})
          }
			function removeCartItems()
			{
				$.ajax({ 						
				    type: "DELETE",
					contentType: 'application/json',
					url:"http://localhost:3000/cart_items/truncate",					
					success: function(data){
						window.location.href=""				
					}
					})
			}
		 </script>
	</head>
	<body>
	</body>
</html>